{% extends 'app/base.html' %}

{% block title %}Send email — Email Bot{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-10">
        <h1 class="text-3xl font-bold tracking-tight mb-3 bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-sky-500">Compose Outreach</h1>
        <p class="text-slate-600 dark:text-slate-300 max-w-2xl">Send personalised, scheduled emails to selected companies. Choose queries, collect businesses and queue your outreach with optional attachments.</p>
    </div>
    <form id="sendEmailForm" method="post" enctype="multipart/form-data" class="grid gap-8 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-8">
            <section class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/70 shadow-soft backdrop-blur p-6 space-y-6">
                <h2 class="text-lg font-semibold flex items-center gap-2"><span class="h-6 w-6 rounded bg-brand-600 text-white text-xs flex items-center justify-center font-semibold">1</span> Select Data</h2>
                {% csrf_token %}
                <div class="grid sm:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="location" class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Location</label>
                        <select id="location" name="location" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60">
                            <option value="">— Select a location —</option>
                            {% for loc in locations %}<option value="{{ loc }}">{{ loc }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <label for="query" class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Queries</label>
                            <button type="button" id="selectAllQueries" class="text-[11px] font-medium px-2 py-1 rounded-md border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600/60">Select all</button>
                        </div>
                        <select id="query" name="query" multiple size="6" class="min-h-[160px] w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/60 px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60"></select>
                        <p class="text-[11px] text-slate-500 dark:text-slate-400">Choose one or more queries.</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label for="reciver" class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Companies</label>
                        <button type="button" id="selectAllCompanies" class="text-[11px] font-medium px-2 py-1 rounded-md border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600/60">Select all</button>
                    </div>
                    <select id="reciver" name="reciver" multiple size="10" class="min-h-[220px] w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/60 px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60"></select>
                    <p class="text-[11px] text-slate-500 dark:text-slate-400">Multi-select with Ctrl / Cmd.</p>
                </div>
            </section>
            <section class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/70 shadow-soft backdrop-blur p-6 space-y-6">
                <h2 class="text-lg font-semibold flex items-center gap-2"><span class="h-6 w-6 rounded bg-brand-600 text-white text-xs flex items-center justify-center font-semibold">2</span> Craft Message</h2>
                <div class="space-y-2">
                    <label for="subject" class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Subject</label>
                    <input id="subject" name="subject" type="text" required class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60" />
                </div>
                <div class="space-y-2">
                    <label for="text" class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Message</label>
                    <textarea id="text" name="text" required class="w-full min-h-48 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/60 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60" placeholder="Introduce yourself, explain the value proposition, include a clear CTA..."></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Attachments</label>
                    <div id="dropZone" class="relative flex flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/40 px-6 py-10 text-center text-sm text-slate-500 dark:text-slate-400 cursor-pointer hover:border-brand-500/70 hover:bg-brand-50 dark:hover:bg-slate-600/40 transition">
                        <svg class="h-8 w-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 16V4m0 0 4 4m-4-4-4 4"/><path d="M20 16.5a3.5 3.5 0 0 1-3.5 3.5h-9A3.5 3.5 0 0 1 4 16.5 5.5 5.5 0 0 1 9.5 11h5A5.5 5.5 0 0 1 20 16.5Z"/></svg>
                        <p><span class="font-medium">Click to upload</span> or drag & drop</p>
                        <p class="text-[11px] text-slate-400">Any relevant documents, PDFs, images.</p>
                        <input id="attachments" name="attachments" type="file" multiple class="absolute inset-0 opacity-0 cursor-pointer" />
                    </div>
                    <ul id="fileList" class="mt-2 space-y-2 text-xs"></ul>
                </div>
            </section>
        </div>
        <aside class="space-y-8">
            <section class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/70 shadow-soft backdrop-blur p-6 space-y-6 sticky top-24">
                <h2 class="text-lg font-semibold flex items-center gap-2"><span class="h-6 w-6 rounded bg-brand-600 text-white text-xs flex items-center justify-center font-semibold">3</span> Schedule</h2>
                <div class="space-y-2">
                    <label for="delay_min" class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Delay (minutes)</label>
                    <input id="delay_min" name="delay_min" type="number" min="0" value="1" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60" />
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400">Summary</label>
                    <ul class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed list-disc pl-4" id="summaryList">
                        <li><span id="summaryQueries">0</span> queries selected</li>
                        <li><span id="summaryCompanies">0</span> companies selected</li>
                        <li><span id="summaryFiles">0</span> attachments</li>
                    </ul>
                </div>
                <div class="pt-2 flex flex-col gap-3">
                    <button type="submit" id="submitBtn" class="inline-flex items-center justify-center gap-2 rounded-md bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 text-sm font-medium shadow-soft focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-600 disabled:opacity-60 disabled:cursor-not-allowed">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="m22 2-7 20-4-9-9-4Z"/></svg>
                        <span>Queue Emails</span>
                    </button>
                    <button type="button" id="clearBtn" class="text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">Clear selections</button>
                </div>
            </section>
        </aside>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const locationSelect=document.getElementById('location');
    const querySelect=document.getElementById('query');
    const companySelect=document.getElementById('reciver');
    const selectAllQueriesBtn=document.getElementById('selectAllQueries');
    const selectAllCompaniesBtn=document.getElementById('selectAllCompanies');
    const summaryQueries=document.getElementById('summaryQueries');
    const summaryCompanies=document.getElementById('summaryCompanies');
    const summaryFiles=document.getElementById('summaryFiles');
    const fileInput=document.getElementById('attachments');
    const fileList=document.getElementById('fileList');
    const dropZone=document.getElementById('dropZone');
    const clearBtn=document.getElementById('clearBtn');
    const submitBtn=document.getElementById('submitBtn');
    function clearSelect(el){el.innerHTML=''}
    function getSelectedValues(el){return Array.from(el.selectedOptions).map(o=>o.value)}
    function extractEmails(raw){if(!raw||typeof raw!=='string')return[];let candidates=[];const trimmed=raw.trim();if((trimmed.startsWith('[')&&trimmed.endsWith(']'))||trimmed.includes(',')){try{const arr=Function('return '+trimmed)();if(Array.isArray(arr))candidates=arr.filter(x=>typeof x==='string')}catch(_){candidates=[raw]}}else{candidates=[raw]}const emailRe=/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig;const badExt=/\.(png|jpg|jpeg|svg|gif|webp)$/i;const out=new Set();for(const c of candidates){if(!c||badExt.test(c))continue;const found=c.match(emailRe)||[];for(const e of found)out.add(e.toLowerCase())}return Array.from(out)}
    function updateSummary(){summaryQueries.textContent=getSelectedValues(querySelect).length;summaryCompanies.textContent=getSelectedValues(companySelect).length;summaryFiles.textContent=fileInput.files.length}
    locationSelect.addEventListener('change',async()=>{clearSelect(querySelect);clearSelect(companySelect);const loc=locationSelect.value;if(!loc)return;const resp=await fetch(`/get_queries_for_location?location=${encodeURIComponent(loc)}`);const data=await resp.json();(data.queries||[]).forEach(q=>{const opt=document.createElement('option');opt.value=q;opt.textContent=q;querySelect.appendChild(opt)});updateSummary()});
    querySelect.addEventListener('change',async()=>{clearSelect(companySelect);const loc=locationSelect.value;const queries=getSelectedValues(querySelect);if(!loc||queries.length===0){updateSummary();return;}const seen=new Set();for(const q of queries){const resp=await fetch(`/get_companies_for_location_query?location=${encodeURIComponent(loc)}&query=${encodeURIComponent(q)}`);const data=await resp.json();(data.companies||[]).forEach(c=>{extractEmails(c.email).forEach(em=>{if(!seen.has(em))seen.add(em)})})}Array.from(seen).forEach(em=>{const opt=document.createElement('option');opt.value=em;opt.textContent=em;companySelect.appendChild(opt)});updateSummary()});
    selectAllQueriesBtn.addEventListener('click',()=>{Array.from(querySelect.options).forEach(o=>o.selected=true);querySelect.dispatchEvent(new Event('change'))});
    selectAllCompaniesBtn.addEventListener('click',()=>{Array.from(companySelect.options).forEach(o=>o.selected=true);updateSummary()});
    fileInput.addEventListener('change',()=>{fileList.innerHTML='';Array.from(fileInput.files).forEach(f=>{const li=document.createElement('li');li.className='flex items-center gap-2 text-slate-600 dark:text-slate-300';li.innerHTML=`<span class='truncate max-w-[160px]'>${f.name}</span><span class='text-[10px] text-slate-400'>${(f.size/1024).toFixed(1)} KB</span>`;fileList.appendChild(li)});updateSummary()});
    ;['dragenter','dragover'].forEach(evt=>dropZone.addEventListener(evt,e=>{e.preventDefault();dropZone.classList.add('ring-2','ring-brand-500/60')}));
    ;['dragleave','drop'].forEach(evt=>dropZone.addEventListener(evt,e=>{e.preventDefault();dropZone.classList.remove('ring-2','ring-brand-500/60')}));
    dropZone.addEventListener('drop',e=>{const dt=e.dataTransfer;if(!dt?.files?.length)return;fileInput.files=dt.files;fileInput.dispatchEvent(new Event('change'))});
    clearBtn.addEventListener('click',()=>{locationSelect.value='';clearSelect(querySelect);clearSelect(companySelect);fileInput.value='';fileList.innerHTML='';updateSummary()});
    companySelect.addEventListener('change',updateSummary);
    document.getElementById('sendEmailForm').addEventListener('submit',e=>{e.preventDefault();submitBtn.disabled=true;submitBtn.classList.add('cursor-wait');const original=submitBtn.querySelector('span').textContent;submitBtn.querySelector('span').textContent='Queuing...';const form=e.currentTarget;const recipients=Array.from(companySelect.selectedOptions).map(o=>o.value);const fd=new FormData(form);fd.delete('reciver');recipients.forEach(r=>fd.append('recipients[]',r));fetch('/send_email',{method:'POST',body:fd}).then(r=>r.json()).then(data=>{pushToast(`Queued ${data.queued} email(s). Delay ${data.delay_min} min`,'success')}).catch(err=>{pushToast('Error: '+err.message,'error')}).finally(()=>{submitBtn.disabled=false;submitBtn.classList.remove('cursor-wait');submitBtn.querySelector('span').textContent=original})});
</script>
{% endblock %}
