{% extends 'app/base.html' %}

{% block title %}Szukaj firm — Email Bot{% endblock %}

{% block content %}
<div class="bg-white border border-slate-200 shadow-sm rounded-xl p-6">
    <h1 class="text-2xl font-semibold text-slate-800 mb-6">Wyszukaj firmy</h1>

    <form id="searchForm" method="post" class="space-y-5">
        {% csrf_token %}

        <div>
            <label for="city" class="block text-sm font-medium text-slate-700 mb-1">Miasto</label>
            <input id="city" name="city" type="text" required placeholder="np. Lublin"
                         class="w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" />
        </div>

        <div>
            <label for="query" class="block text-sm font-medium text-slate-700 mb-1">Fraza</label>
            <input id="query" name="query" type="text" required placeholder="np. cukiernie"
                         class="w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" />
        </div>

        <button type="submit"
                        class="inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Szukaj firm
        </button>
    </form>

    <div id="result" class="mt-6 hidden"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('searchForm');
    const resultDiv = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const city = document.getElementById('city').value;
        const query = document.getElementById('query').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        resultDiv.className = 'mt-6 p-4 rounded-md bg-slate-50 border border-slate-200 text-slate-700';
        resultDiv.classList.remove('hidden');
        resultDiv.textContent = 'Szukam...';

        try {
            const resp = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `city=${encodeURIComponent(city)}&query=${encodeURIComponent(query)}`
            });
            const data = await resp.json();

            if (data && Array.isArray(data.companies)) {
                const companies = data.companies;
                const companyCount = data.company_count || companies.length;
                const items = companies.map(c => `
                    <li class="border border-slate-200 rounded-md p-3">
                        <div class="font-medium text-slate-800">${c.name}</div>
                        ${c.address ? `<div class="text-slate-600 text-sm">${c.address}</div>` : ''}
                        <div class="text-slate-600 text-sm space-x-3">
                            ${c.phones ? `<span>Tel: ${c.phones}</span>` : ''}
                            ${c.email ? `<span>Email: ${c.email}</span>` : ''}
                            ${c.website ? `<a class="text-indigo-600 hover:underline" target="_blank" href="${c.website}">${c.website}</a>` : ''}
                        </div>
                    </li>`).join('');
                resultDiv.innerHTML = `
                    <div class="mb-3 text-slate-800 font-medium">Wyniki dla: <span class="text-slate-600">${data.search_query || ''}</span></div>
                    <div class="mb-4 text-sm text-slate-600">Znaleziono: <strong>${companyCount}</strong> firm</div>
                    <ul class="space-y-2 max-h-96 overflow-auto">${items || '<li class="text-slate-600">Brak firm</li>'}</ul>`;
            } else if (data && data.error) {
                resultDiv.className = 'mt-6 p-4 rounded-md bg-rose-50 border border-rose-200 text-rose-800';
                resultDiv.innerHTML = `<strong>Błąd:</strong> ${data.error}`;
            } else {
                resultDiv.className = 'mt-6 p-4 rounded-md bg-rose-50 border border-rose-200 text-rose-800';
                resultDiv.textContent = 'Nieprawidłowa odpowiedź z serwera.';
            }
        } catch (err) {
            resultDiv.className = 'mt-6 p-4 rounded-md bg-rose-50 border border-rose-200 text-rose-800';
            resultDiv.textContent = `Błąd sieci: ${err.message}`;
        }
    });
</script>
{% endblock %}
